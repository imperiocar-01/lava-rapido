<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imp√©rioCar-01 | Agendamento VIP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <!-- SUPABASE -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --gold: #FFD700; --gold-dark: #B8860B; --black: #0a0a0a;
            --gray-dark: #141414; --gray-light: #2a2a2a;
            --whatsapp: #25D366; --danger: #ff4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--black); color: white; padding-bottom: 140px; }
        
        .header { background: linear-gradient(to bottom, rgba(0,0,0,0.7), var(--black)), url('https://images.unsplash.com/photo-1601362840469-51e4d8d58785?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'); background-size: cover; background-position: center; text-align: center; padding: 40px 20px 20px 20px; border-bottom: 3px solid var(--gold); }
        .logo h1 { color: var(--gold); font-weight: 900; font-size: 1.8rem; text-transform: uppercase; }
        .logo p { font-size: 0.8rem; letter-spacing: 2px; color: #ddd; }
        
        .container { width: 100%; max-width: 600px; margin: 0 auto; padding: 15px; }
        
        /* VITRINE */
        .gallery-container { position: relative; width: 100%; height: 220px; border-radius: 10px; overflow: hidden; border: 2px solid var(--gold); margin-bottom: 25px; background: #000; }
        .gallery-slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 1s; object-fit: cover; }
        .gallery-slide.active { opacity: 1; }
        .gallery-caption { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: var(--gold); padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }

        .section-title { font-size: 1rem; color: var(--gold); margin: 25px 0 10px 0; text-transform: uppercase; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .section-title::after { content: ''; flex: 1; height: 1px; background: #333; }
        
        .date-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .date-btn { flex: 1; padding: 15px; background-color: var(--gray-light); border: 1px solid #444; color: #ccc; border-radius: 8px; font-weight: bold; font-size: 0.9rem; text-transform: uppercase; cursor: pointer; }
        .date-btn.selected { background-color: var(--gold); color: var(--black); border-color: var(--gold); }
        
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; min-height: 80px; }
        .time-btn { background-color: var(--gray-light); border: 1px solid #444; color: #ccc; padding: 12px 5px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; text-align: center; }
        .time-btn.selected { background-color: var(--gold); color: var(--black); font-weight: 900; border-color: var(--gold); }
        .time-btn.disabled { background-color: #111; color: #444; border-color: #222; cursor: not-allowed; text-decoration: line-through; }
        
        select, .payment-select { width: 100%; padding: 15px; background-color: var(--gray-light); border: 1px solid #333; color: white; border-radius: 8px; font-size: 1rem; margin-bottom: 10px; }
        .service-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--gray-light); padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 10px; }
        .service-item input { transform: scale(1.3); accent-color: var(--gold); margin-right: 10px;}
        .price-tag { color: var(--gold); font-weight: bold; }
        
        .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(0,0,0,0.95); padding: 15px; border-top: 1px solid #333; display: flex; flex-direction: column; align-items: center; z-index: 100; }
        .btn-whatsapp { background-color: var(--whatsapp); color: white; text-decoration: none; padding: 16px; border-radius: 50px; font-weight: 800; width: 100%; text-align: center; display: block; border: none; font-size: 1rem; cursor: pointer; }
        
        /* ADMIN */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; align-items:center; justify-content:center; }
        .modal-content { background:#1a1a1a; padding:20px; border:2px solid var(--gold); width:90%; max-width:400px; text-align:center; border-radius:10px; max-height: 80vh; overflow-y: auto;}
        .admin-input { width:100%; padding:10px; margin:10px 0; background:#333; border:1px solid #555; color:white; }
        .admin-btn { background:var(--gold); border:none; padding:10px; width:100%; font-weight:bold; margin-top:5px; cursor:pointer; }
        
        .admin-photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        .admin-photo-item { position: relative; height: 60px; }
        .admin-photo-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; border: 1px solid #444; }
        .delete-btn { position: absolute; top:0; right:0; background:red; color:white; border:none; width:20px; height:20px; font-size:10px; cursor:pointer;}
    </style>
</head>
<body>

    <div class="header">
        <div class="logo" id="crownLogo">
            <i class="fas fa-crown" style="color: var(--gold); font-size: 2.5rem; margin-bottom: 10px;"></i>
            <h1>Imp√©rioCar-01</h1>
            <p>LAVA-R√ÅPIDO & EST√âTICA</p>
        </div>
    </div>

    <div class="container">
        <!-- VITRINE -->
        <div class="section-title">VITRINE (VE√çCULOS PRONTOS)</div>
        <div class="gallery-container" id="galleryContainer"></div>

        <div style="background:rgba(184,134,11,0.15); border:1px solid var(--gold-dark); padding:15px; border-radius:8px; font-size:0.85rem; margin-bottom:20px; text-align:center; color:#ddd;">
            <i class="fas fa-info-circle"></i> Os agendamentos s√£o salvos no sistema e confirmados via WhatsApp.
        </div>

        <div class="section-title">ESCOLHA O DIA</div>
        <div class="date-selector">
            <button class="date-btn selected" id="btnToday" onclick="mudarData('hoje')">HOJE<br><span id="labelToday" style="font-size:0.7rem">--/--</span></button>
            <button class="date-btn" id="btnTomorrow" onclick="mudarData('amanha')">AMANH√É<br><span id="labelTomorrow" style="font-size:0.7rem">--/--</span></button>
        </div>

        <div class="section-title">VE√çCULO</div>
        <select id="carSize" onchange="calcular()">
            <option value="pequeno">Carro Pequeno (Hatch)</option>
            <option value="medio" selected>Carro M√©dio (Sedan)</option>
            <option value="grande">Carro Grande (SUV/Pick-up)</option>
            <option value="moto">Moto</option>
        </select>

        <div class="section-title">HOR√ÅRIO</div>
        <div class="time-grid" id="gridHorarios"></div>
        
        <div class="section-title">SERVI√áO</div>
        <div id="listaServicos"></div>

        <div class="section-title">PAGAMENTO</div>
        <select id="pagamento" onchange="calcular()">
            <option value="Pix">Pix</option>
            <option value="Cart√£o">Cart√£o Cr√©dito/D√©bito</option>
            <option value="Dinheiro">Dinheiro</option>
        </select>
        
        <div style="height: 20px;"></div>
        <div style="text-align:center; font-size:0.8rem; color:#666;">Rua Giovanni Segantini, 257A<br>Jos√© Bonif√°cio - SP</div>
    </div>

    <div class="sticky-footer">
        <div style="color:#ccc; margin-bottom:5px;">Total: <span id="valorTotal" style="color:var(--gold); font-weight:900; font-size:1.3rem;">R$ 0,00</span></div>
        <button id="btnZap" class="btn-whatsapp">AGENDAR NO WHATSAPP</button>
    </div>

    <!-- PAIN√âIS ADMIN -->
    <div id="modalLogin" class="modal-overlay">
        <div class="modal-content">
            <h3>√ÅREA ADMIN</h3>
            <input type="password" id="senhaAdmin" class="admin-input" placeholder="Senha">
            <button onclick="logarAdmin()" class="admin-btn">ENTRAR</button>
            <button onclick="document.getElementById('modalLogin').style.display='none'" class="admin-btn" style="background:#444; color:white;">FECHAR</button>
        </div>
    </div>
    
    <div id="painelAdmin" class="modal-overlay">
        <div class="modal-content">
            <h3>PAINEL DE CONTROLE</h3>
            <div style="text-align:left; border-bottom:1px solid #444; padding-bottom:15px; margin-bottom:15px;">
                <h4 style="color:white; margin-bottom:5px;">üì∏ Fotos da Vitrine</h4>
                <label for="fileInput" class="admin-btn" style="background:#444; color:white; font-size:0.9rem;">
                    <i class="fas fa-images"></i> ADICIONAR FOTOS
                </label>
                <input type="file" id="fileInput" accept="image/*" multiple style="display:none;" onchange="handleFileUpload(this)">
                <div id="adminPhotoGrid" class="admin-photo-grid"></div>
            </div>
            <div id="editorPrecos" style="text-align:left; max-height:200px; overflow-y:scroll; border-bottom:1px solid #444; margin-bottom:10px;"></div>
            <button onclick="salvarPrecos()" class="admin-btn">SALVAR ALTERA√á√ïES</button>
            <button onclick="document.getElementById('painelAdmin').style.display='none'" class="admin-btn" style="background:#c00; color:white;">SAIR</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURA√á√ÉO (J√Å PREENCHI COM SUAS CHAVES DO IMPERIOCAR-01) ---
        const supabaseUrl = 'https://jmivkvtebtjudqhvgc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptaXZrdmV0ZWJ0anVkcWh2dmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MjIzMTYsImV4cCI6MjA4MDE5ODMxNn0.WtPrTn0Kvx6o_h_ZfNoAcQGjNDErr0NqT0wt60YLlo0';
        
        let supabase = null;
        try { 
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        } catch (e) { 
            console.error("Erro Supabase", e);
        }

        // --- 2. VARI√ÅVEIS GLOBAIS ---
        let diaSelecionado = 'hoje';
        let horaSelecionada = null;
        
        const defaultPrices = {
            moto: { ducha: 20, simples: 30, cera: 40, higienizacao: 100 },
            pequeno: { ducha: 30, simples: 45, cera: 60, higienizacao: 200 },
            medio: { ducha: 35, simples: 50, cera: 70, higienizacao: 250 },
            grande: { ducha: 50, simples: 70, cera: 90, higienizacao: 300 }
        };
        const defaultPhotos = [
            "https://images.unsplash.com/photo-1601362840469-51e4d8d58785?w=600&q=80",
            "https://images.unsplash.com/photo-1520340356584-7c903ccf70dc?w=600&q=80"
        ];
        
        // Carrega dados locais (Funciona mesmo sem internet)
        let precos = JSON.parse(localStorage.getItem('precosImperio')) || defaultPrices;
        let galleryPhotos = JSON.parse(localStorage.getItem('imperioPhotos')) || defaultPhotos;
        let currentSlide = 0;
        let slideInterval;
        
        const servicosOpcoes = [
            { id: 'ducha', nome: 'S√≥ Ducha', desc: 'Externa R√°pida' },
            { id: 'simples', nome: 'Lavagem Simples', desc: 'Int/Ext + Aspirar' },
            { id: 'cera', nome: 'Lavagem c/ Cera', desc: 'Completa + Cera' },
            { id: 'higienizacao', nome: 'Higieniza√ß√£o', desc: 'Interna Profunda' }
        ];

        // --- 3. INICIALIZAR ---
        window.onload = function() {
            initGallery();
            renderizarDatas();
            renderizarServicos();
            gerarHorariosSimples(); 
            calcular();
            initAdminTrigger();
            
            // GARANTIA: SE O BOT√ÉO N√ÉO EXISTIR, ELE N√ÉO QUEBRA
            const btn = document.getElementById('btnZap');
            if(btn) btn.onclick = processarAgendamento;
        };

        // --- 4. FUN√á√ÉO DE AGENDAMENTO (BLINDADA) ---
        async function processarAgendamento(e) {
            e.preventDefault();
            const btn = document.getElementById('btnZap');

            // Valida√ß√£o
            if (!horaSelecionada && horaSelecionada !== 'Encaixe') {
                alert("‚ö†Ô∏è Por favor, escolha um hor√°rio.");
                return;
            }

            // Visual de carregando
            btn.innerText = "‚è≥ Processando...";
            btn.disabled = true;

            // 1. Prepara os dados
            const tamanho = document.getElementById('carSize').value;
            const servicoRadio = document.querySelector('input[name="servico"]:checked');
            const servicoNome = servicoOpcoes.find(s => s.id === servicoRadio.value).nome;
            const valor = document.getElementById('valorTotal').innerText.replace('R$ ', '');
            const pag = document.getElementById('pagamento').value;
            const dataStr = getDataFormatada(diaSelecionado);
            const horaMsg = horaSelecionada || "Encaixe";

            // 2. Monta Link do WhatsApp (Isso NUNCA falha)
            const msg = `üëë *NOVO AGENDAMENTO*\n\nüóì ${dataStr}\n‚è∞ *${horaMsg}*\n\nüöó ${tamanho.toUpperCase()}\nüöø ${servicoNome}\nüí∞ R$ ${valor}\nüí≥ ${pag}`;
            const linkZap = `https://wa.me/5511960671570?text=${encodeURIComponent(msg)}`;

            // 3. Tenta salvar no Banco (Agora deve funcionar!)
            if (supabase) {
                try {
                    await supabase.from('agendamentos_imperio').insert({
                        data_escolhida: dataStr,
                        horario: horaMsg,
                        tamanho_carro: tamanho,
                        servico_nome: servicoNome,
                        valor_cobrado: parseFloat(valor.replace(',', '.')),
                        forma_pagamento: pag
                    });
                } catch (erroBanco) {
                    console.log("Banco indispon√≠vel, mas vamos abrir o WhatsApp.", erroBanco);
                }
            }

            // 4. Redireciona para o WhatsApp
            window.location.href = linkZap;
            
            setTimeout(() => {
                btn.innerText = "AGENDAR NO WHATSAPP";
                btn.disabled = false;
            }, 2000);
        }

        // --- 5. L√ìGICA DE INTERFACE ---
        function getDataFormatada(tipo) {
            const hoje = new Date();
            const amanha = new Date(hoje); amanha.setDate(hoje.getDate() + 1);
            const diasSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const dataObj = tipo === 'hoje' ? hoje : amanha;
            return `${dataObj.getDate().toString().padStart(2,'0')}/${(dataObj.getMonth()+1).toString().padStart(2,'0')} (${diasSemana[dataObj.getDay()]})`;
        }

        function renderizarDatas() {
            const hoje = new Date();
            const amanha = new Date(hoje); amanha.setDate(hoje.getDate() + 1);
            const formatar = (d) => `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}`;
            document.getElementById('labelToday').innerText = formatar(hoje);
            document.getElementById('labelTomorrow').innerText = formatar(amanha);
        }

        function renderizarServicos() {
            const container = document.getElementById('listaServicos');
            let html = '';
            servicosOpcoes.forEach((svc, index) => {
                const checked = index === 1 ? 'checked' : ''; 
                html += `
                <label class="service-item">
                    <div style="display:flex; align-items:center;">
                        <input type="radio" name="servico" value="${svc.id}" ${checked} onchange="calcular()">
                        <div><span style="font-weight:bold;">${svc.nome}</span><br><span style="font-size:0.8rem; color:#888;">${svc.desc}</span></div>
                    </div>
                    <span class="price-tag" id="tag-${svc.id}">R$ 00</span>
                </label>`;
            });
            container.innerHTML = html;
        }

        function mudarData(tipo) {
            diaSelecionado = tipo;
            document.getElementById('btnToday').className = tipo === 'hoje' ? 'date-btn selected' : 'date-btn';
            document.getElementById('btnTomorrow').className = tipo === 'amanha' ? 'date-btn selected' : 'date-btn';
            horaSelecionada = null; 
            gerarHorariosSimples();
            calcular();
        }

        function gerarHorariosSimples() {
            const grid = document.getElementById('gridHorarios');
            grid.innerHTML = '';
            grid.innerHTML += `<div class="time-btn" style="grid-column:1/-1; background:rgba(255,68,68,0.2); color:#ffaaaa; border:1px solid red;" onclick="selecionarHora(this, 'Encaixe')">ENCAIXE (Sem hora fixa)</div>`;

            let minutos = 8 * 60; 
            const horaAtual = new Date().getHours();
            const minAtual = new Date().getMinutes();

            while(minutos < 18 * 60) {
                const h = Math.floor(minutos/60);
                const m = minutos % 60;
                const horaFormatada = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                
                let classeExtra = '';
                let bloqueado = false;

                // Bloqueia hor√°rios passados
                if (diaSelecionado === 'hoje') {
                    if (h < horaAtual || (h === horaAtual && m < minAtual)) {
                        classeExtra = 'disabled'; bloqueado = true;
                    }
                }

                const clickAction = bloqueado ? '' : `onclick="selecionarHora(this, '${horaFormatada}')"`;
                grid.innerHTML += `<div class="time-btn ${classeExtra}" ${clickAction}>${horaFormatada}</div>`;
                minutos += 45;
            }
        }

        function selecionarHora(el, hora) {
            document.querySelectorAll('.time-btn').forEach(b => {
                if(!b.classList.contains('disabled')) b.classList.remove('selected');
            });
            el.classList.add('selected');
            horaSelecionada = hora;
        }

        function calcular() {
            const tamanho = document.getElementById('carSize').value;
            const servicoRadio = document.querySelector('input[name="servico"]:checked');
            const servicoId = servicoRadio ? servicoRadio.value : 'simples';
            
            servicosOpcoes.forEach(s => {
                const valor = precos[tamanho][s.id];
                document.getElementById(`tag-${s.id}`).innerText = `R$ ${valor}`;
            });
            const total = precos[tamanho][servicoId];
            document.getElementById('valorTotal').innerText = `R$ ${total},00`;
        }

        // --- 6. GALERIA E ADMIN ---
        function initGallery() {
            const container = document.getElementById('galleryContainer');
            container.innerHTML = '';
            if(galleryPhotos.length === 0) {
                container.innerHTML = '<div style="color:white; display:flex; justify-content:center; align-items:center; height:100%;">Sem fotos na vitrine</div><div class="gallery-caption">Adicione fotos no Admin</div>';
                return;
            }
            galleryPhotos.forEach((url, index) => {
                const img = document.createElement('img');
                img.src = url;
                img.className = index === 0 ? 'gallery-slide active' : 'gallery-slide';
                container.appendChild(img);
            });
            const caption = document.createElement('div');
            caption.className = 'gallery-caption';
            caption.innerHTML = 'Resultado Final ‚ú®';
            container.appendChild(caption);
            if (slideInterval) clearInterval(slideInterval);
            if (galleryPhotos.length > 1) { slideInterval = setInterval(nextSlide, 3000); }
        }
        function nextSlide() {
            const slides = document.querySelectorAll('.gallery-slide');
            if (slides.length === 0) return;
            slides[currentSlide].classList.remove('active');
            currentSlide = (currentSlide + 1) % slides.length;
            slides[currentSlide].classList.add('active');
        }
        let clicks = 0;
        function initAdminTrigger() {
            document.getElementById('crownLogo').onclick = () => {
                clicks++;
                if(clicks===5) { document.getElementById('modalLogin').style.display='flex'; clicks=0; }
                setTimeout(()=>clicks=0, 2000);
            };
        }
        function logarAdmin() {
            if(document.getElementById('senhaAdmin').value === '#Ccjj9842$') {
                document.getElementById('modalLogin').style.display='none';
                document.getElementById('painelAdmin').style.display='flex';
                montarEditorPrecos();
                renderAdminPhotos();
            } else alert('Senha errada');
        }
        function montarEditorPrecos() {
            const div = document.getElementById('editorPrecos');
            div.innerHTML = '';
            for(let tam in precos) {
                div.innerHTML += `<h4 style="color:var(--gold); margin-top:10px">${tam.toUpperCase()}</h4>`;
                for(let s in precos[tam]) {
                    div.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>${s}</span>
                        <input type="number" id="p-${tam}-${s}" value="${precos[tam][s]}" style="width:60px">
                    </div>`;
                }
            }
        }
        function salvarPrecos() {
            for(let tam in precos) { for(let s in precos[tam]) { precos[tam][s] = Number(document.getElementById(`p-${tam}-${s}`).value); } }
            localStorage.setItem('precosImperio', JSON.stringify(precos));
            localStorage.setItem('imperioPhotos', JSON.stringify(galleryPhotos));
            alert('Tudo salvo!');
            document.getElementById('painelAdmin').style.display='none';
            calcular(); initGallery();
        }
        function renderAdminPhotos() {
            const container = document.getElementById('adminPhotoGrid'); container.innerHTML = '';
            galleryPhotos.forEach((url, index) => {
                const div = document.createElement('div'); div.className = 'admin-photo-item';
                div.innerHTML = `<img src="${url}"><button class="delete-btn" onclick="deletePhoto(${index})">X</button>`;
                container.appendChild(div);
            });
        }
        function deletePhoto(index) {
            if(confirm('Apagar foto?')) { galleryPhotos.splice(index, 1); renderAdminPhotos(); }
        }
        async function handleFileUpload(input) {
            if (input.files && input.files.length > 0) {
                let processedCount = 0;
                for(let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    try {
                        const resizedBase64 = await compressImage(file);
                        galleryPhotos.push(resizedBase64); processedCount++;
                    } catch (err) { console.error("Erro", err); }
                }
                if(processedCount > 0) { renderAdminPhotos(); alert(`${processedCount} fotos prontas! Clique em SALVAR ALTERA√á√ïES.`); }
                input.value = '';
            }
        }
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const maxWidth = 600;
                        const scaleSize = maxWidth / img.width; canvas.width = maxWidth; canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    }; img.onerror = (err) => reject(err);
                }; reader.onerror = (err) => reject(err);
            });
        }
    </script>
</body>
</html>
