<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imp√©rioCar-01 | Agendamento</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --gold: #FFD700; --black: #0a0a0a; --gray: #1a1a1a; --green: #25D366; }
        body { background: var(--black); color: white; font-family: 'Montserrat', sans-serif; padding-bottom: 50px; margin:0; }
        
        .header { background: linear-gradient(to bottom, rgba(0,0,0,0.8), var(--black)), url('https://images.unsplash.com/photo-1601362840469-51e4d8d58785?w=800') center/cover; text-align: center; padding: 30px 20px; border-bottom: 2px solid var(--gold); }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        .section-title { color: var(--gold); font-size: 0.9rem; font-weight: 800; margin: 20px 0 10px 0; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .date-selector { display: flex; gap: 10px; }
        .date-btn { flex: 1; padding: 15px; background: var(--gray); border: 1px solid #444; color: #ccc; border-radius: 8px; cursor: pointer; text-align: center; }
        .date-btn.selected { background: var(--gold); color: black; font-weight: bold; border-color: var(--gold); }
        
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .time-btn { padding: 10px; background: var(--gray); border: 1px solid #444; color: white; border-radius: 6px; text-align: center; font-size: 0.85rem; cursor: pointer; }
        .time-btn.selected { background: var(--gold); color: black; font-weight: bold; }
        .time-btn.disabled { background: #111; color: #444; text-decoration: line-through; cursor: not-allowed; border-color: #222; }
        .time-btn.occupied { background: #500; color: #f99; border-color: #f00; cursor: not-allowed; opacity: 0.7; }

        select, input { width: 100%; padding: 15px; background: var(--gray); border: 1px solid #333; color: white; border-radius: 8px; font-size: 1rem; margin-bottom: 10px; outline: none; }
        
        .service-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--gray); border: 1px solid #333; border-radius: 8px; margin-bottom: 8px; }
        .service-item input { width: auto; margin: 0 10px 0 0; transform: scale(1.3); accent-color: var(--gold); }

        .btn-main { background: var(--gold); color: black; width: 100%; padding: 18px; border: none; border-radius: 50px; font-weight: 900; font-size: 1.1rem; margin-top: 20px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); }
        
        /* === MODAL DE COMPROVANTE (IMPORTANTE) === */
        .modal-overlay { 
            display: none; /* Come√ßa escondido */
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.95); z-index: 9999; 
            align-items: center; justify-content: center; 
        }
        .receipt-card { background: white; color: black; width: 90%; max-width: 350px; border-radius: 15px; padding: 0; overflow: hidden; box-shadow: 0 0 30px rgba(255,215,0,0.5); border: 4px solid var(--gold); }
        .receipt-header { background: var(--gold); padding: 20px; text-align: center; font-weight: 900; font-size: 1.2rem; }
        .receipt-body { padding: 20px; font-size: 0.9rem; line-height: 1.6; }
        .receipt-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding: 8px 0; }
        .receipt-btn { background: var(--green); color: white; border: none; width: 100%; padding: 18px; font-weight: bold; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; text-decoration: none;}
    </style>
</head>
<body>

    <div class="header">
        <i class="fas fa-crown" style="color: var(--gold); font-size: 2rem;"></i>
        <h2 style="color: var(--gold); margin: 5px 0;">Imp√©rioCar-01</h2>
        <p style="color: #ccc; margin: 0; font-size: 0.8rem;">AGENDAMENTO INTELIGENTE</p>
    </div>

    <div class="container">
        
        <div class="section-title">1. ESCOLHA O DIA</div>
        <div class="date-selector">
            <button class="date-btn selected" id="btnToday" onclick="mudarData('hoje')">HOJE<br><span id="labelToday">--/--</span></button>
            <button class="date-btn" id="btnTomorrow" onclick="mudarData('amanha')">AMANH√É<br><span id="labelTomorrow">--/--</span></button>
        </div>

        <div class="section-title">2. SEU VE√çCULO</div>
        <select id="carSize" onchange="calcular()">
            <option value="pequeno">Carro Pequeno (Hatch)</option>
            <option value="medio" selected>Carro M√©dio (Sedan)</option>
            <option value="grande">Carro Grande (SUV/Pick-up)</option>
            <option value="moto">Moto</option>
        </select>

        <div class="section-title">3. HOR√ÅRIO</div>
        <div class="time-grid" id="gridHorarios">Carregando...</div>

        <div class="section-title">4. SERVI√áO</div>
        <div id="listaServicos"></div>

        <div class="section-title">5. FINALIZAR</div>
        <input type="text" id="nomeCliente" placeholder="Seu Nome Completo">
        <select id="pagamento">
            <option value="Pix">Pagamento via Pix</option>
            <option value="Cart√£o">Cart√£o Cr√©dito/D√©bito</option>
            <option value="Dinheiro">Dinheiro</option>
        </select>

        <div style="text-align: center; margin-top: 20px;">
            <span style="color:#888;">Total a Pagar:</span><br>
            <span id="valorTotal" style="color:var(--gold); font-size: 2rem; font-weight: 900;">R$ 0,00</span>
        </div>

        <button id="btnAgendar" class="btn-main" onclick="gerarComprovante()">CONFIRMAR AGENDAMENTO</button>
    </div>

    <!-- COMPROVANTE (MODAL) -->
    <div id="modalComprovante" class="modal-overlay">
        <div class="receipt-card">
            <div class="receipt-header">‚úÖ AGENDADO!</div>
            <div class="receipt-body">
                <div class="receipt-row"><span>Cliente:</span> <strong id="recNome">--</strong></div>
                <div class="receipt-row"><span>Data:</span> <strong id="recData">--</strong></div>
                <div class="receipt-row"><span>Hor√°rio:</span> <strong id="recHora">--</strong></div>
                <div class="receipt-row"><span>Ve√≠culo:</span> <strong id="recCarro">--</strong></div>
                <div class="receipt-row"><span>Servi√ßo:</span> <strong id="recServico">--</strong></div>
                <div class="receipt-row"><span>Valor:</span> <strong id="recValor" style="color:green">--</strong></div>
                
                <div style="margin-top: 15px; font-size: 0.8rem; text-align: center; background:#eee; padding:5px; border-radius:4px;">
                    Protocolo: <strong id="recID">GERANDO...</strong>
                </div>
            </div>
            <button id="btnZapFinal" class="receipt-btn" onclick="enviarZap()">
                <i class="fab fa-whatsapp"></i> ENVIAR NO WHATSAPP
            </button>
            <button onclick="location.reload()" style="width:100%; padding:15px; background:#333; color:white; border:none; cursor:pointer;">FECHAR</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURA√á√ÉO (SUAS CHAVES) ---
        const supabaseUrl = 'https://jmivkvtebtjudqhvgc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptaXZrdmV0ZWJ0anVkcWh2dmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MjIzMTYsImV4cCI6MjA4MDE5ODMxNn0.WtPrTn0Kvx6o_h_ZfNoAcQGjNDErr0NqT0wt60YLlo0';
        let supabase = null;
        try { supabase = window.supabase.createClient(supabaseUrl, supabaseKey); } catch(e){}

        // --- 2. DADOS ---
        let diaSelecionado = 'hoje';
        let horaSelecionada = null;
        
        const precos = {
            moto: { ducha: 20, simples: 30, cera: 40, higienizacao: 100 },
            pequeno: { ducha: 30, simples: 45, cera: 60, higienizacao: 200 },
            medio: { ducha: 35, simples: 50, cera: 70, higienizacao: 250 },
            grande: { ducha: 50, simples: 70, cera: 90, higienizacao: 300 }
        };
        
        const servicos = [
            {id: 'ducha', nome: 'S√≥ Ducha'},
            {id: 'simples', nome: 'Lavagem Simples', padrao: true},
            {id: 'cera', nome: 'Lavagem c/ Cera'},
            {id: 'higienizacao', nome: 'Higieniza√ß√£o'}
        ];

        // --- 3. IN√çCIO ---
        window.onload = function() {
            renderDatas();
            renderServicos();
            mudarData('hoje'); 
            calcular();
        };

        // --- 4. GERA√á√ÉO DE HOR√ÅRIOS COM TRAVA DE HORA PASSADA ---
        function renderDatas() {
            const hoje = new Date();
            const amanha = new Date(hoje); amanha.setDate(hoje.getDate() + 1);
            document.getElementById('labelToday').innerText = `${hoje.getDate()}/${hoje.getMonth()+1}`;
            document.getElementById('labelTomorrow').innerText = `${amanha.getDate()}/${amanha.getMonth()+1}`;
        }

        async function mudarData(dia) {
            diaSelecionado = dia;
            document.getElementById('btnToday').className = dia === 'hoje' ? 'date-btn selected' : 'date-btn';
            document.getElementById('btnTomorrow').className = dia === 'amanha' ? 'date-btn selected' : 'date-btn';
            horaSelecionada = null;
            await gerarHorarios(); 
        }

        async function gerarHorarios() {
            const grid = document.getElementById('gridHorarios');
            grid.innerHTML = '<div style="color:#888; grid-column:1/-1; text-align:center;">Atualizando...</div>';

            const agora = new Date();
            const horaAtual = agora.getHours();
            const dataStr = getDataFormatada(diaSelecionado);
            
            let ocupados = [];
            // Busca no banco se poss√≠vel
            if(supabase) {
                try {
                    const { data } = await supabase.from('agendamentos_imperio').select('horario').eq('data_escolhida', dataStr);
                    if(data) ocupados = data.map(x => x.horario);
                } catch(e) {}
            }

            grid.innerHTML = '';
            // Encaixe sempre livre
            grid.innerHTML += `<div class="time-btn" style="border-color:var(--gold); color:var(--gold);" onclick="selectHora(this, 'Encaixe')">ENCAIXE</div>`;

            let minutos = 8 * 60; // 08:00
            while(minutos < 18 * 60) {
                const h = Math.floor(minutos/60);
                const m = minutos % 60;
                const horaTxt = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                
                let classe = 'time-btn';
                let blocked = false;

                // 1. Passou da hora?
                if (diaSelecionado === 'hoje') {
                    if (h < horaAtual || (h === horaAtual && m < agora.getMinutes())) {
                        classe += ' disabled'; blocked = true;
                    }
                }
                // 2. Est√° ocupado no banco?
                if (ocupados.includes(horaTxt)) {
                    classe += ' occupied'; blocked = true;
                }

                const action = blocked ? '' : `onclick="selectHora(this, '${horaTxt}')"`;
                grid.innerHTML += `<div class="${classe}" ${action}>${horaTxt}</div>`;
                minutos += 60; 
            }
        }

        function selectHora(el, hora) {
            document.querySelectorAll('.time-btn').forEach(b => {
                if(!b.classList.contains('disabled') && !b.classList.contains('occupied')) b.classList.remove('selected');
            });
            el.classList.add('selected');
            horaSelecionada = hora;
        }

        // --- 5. A√á√ÉO DE CONFIRMAR (ABRE MODAL PRIMEIRO) ---
        async function gerarComprovante() {
            const nome = document.getElementById('nomeCliente').value;
            if(!horaSelecionada) return alert('Selecione um hor√°rio!');
            if(!nome) return alert('Digite seu nome!');

            // 1. PREENCHE O MODAL IMEDIATAMENTE (Feedback Instant√¢neo)
            const tamanho = document.getElementById('carSize').value;
            const servicoId = document.querySelector('input[name="svc"]:checked').value;
            const servicoNome = servicos.find(s => s.id === servicoId).nome;
            const valor = document.getElementById('valorTotal').innerText;
            const dataStr = getDataFormatada(diaSelecionado);
            
            document.getElementById('recNome').innerText = nome;
            document.getElementById('recData').innerText = dataStr;
            document.getElementById('recHora').innerText = horaSelecionada;
            document.getElementById('recCarro').innerText = tamanho.toUpperCase();
            document.getElementById('recServico').innerText = servicoNome;
            document.getElementById('recValor').innerText = valor;
            
            // Abre o modal
            document.getElementById('modalComprovante').style.display = 'flex';

            // 2. TENTA SALVAR NO BANCO (EM SEGUNDO PLANO)
            let idGerado = "OFFLINE-" + Math.floor(Math.random() * 10000);
            
            if(supabase) {
                try {
                    const { data } = await supabase.from('agendamentos_imperio').insert({
                        cliente_nome: nome,
                        data_escolhida: dataStr,
                        horario: horaSelecionada,
                        tamanho_carro: tamanho,
                        servico_nome: servicoNome,
                        valor_cobrado: parseFloat(valor.replace('R$ ','').replace(',','.')),
                        forma_pagamento: document.getElementById('pagamento').value
                    }).select();
                    
                    if(data && data[0]) idGerado = data[0].id.split('-')[0].toUpperCase();
                } catch(e) { console.log("Erro banco", e); }
            }
            
            // Atualiza o ID no modal com o valor real ou offline
            document.getElementById('recID').innerText = idGerado;
        }

        function enviarZap() {
            const nome = document.getElementById('recNome').innerText;
            const data = document.getElementById('recData').innerText;
            const hora = document.getElementById('recHora').innerText;
            const servico = document.getElementById('recServico').innerText;
            const id = document.getElementById('recID').innerText;
            const msg = `üßæ *COMPROVANTE*\nüë§ ${nome}\nüìÖ ${data} √†s ${hora}\nüöø ${servico}\nüÜî ${id}`;
            window.location.href = `https://wa.me/5511960671570?text=${encodeURIComponent(msg)}`;
        }

        // --- EXTRAS ---
        function renderServicos() {
            const div = document.getElementById('listaServicos');
            let html = '';
            servicos.forEach(s => {
                const check = s.padrao ? 'checked' : '';
                html += `<label class="service-item"><span>${s.nome}</span><input type="radio" name="svc" value="${s.id}" ${check} onchange="calcular()"></label>`;
            });
            div.innerHTML = html;
        }
        function calcular() {
            const tam = document.getElementById('carSize').value;
            const svc = document.querySelector('input[name="svc"]:checked').value;
            const val = precos[tam][svc];
            document.getElementById('valorTotal').innerText = `R$ ${val},00`;
        }
        function getDataFormatada(tipo) {
            const d = new Date();
            if(tipo === 'amanha') d.setDate(d.getDate() + 1);
            return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}`;
        }
    </script>
</body>
</html>
