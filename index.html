<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imp√©rioCar | Agendamento</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --gold: #FFD700; --black: #111; --gray: #222; --green: #25D366; }
        * { box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--black); color: white; margin: 0; padding-bottom: 90px; }

        /* HEADER */
        .header { background: #000; padding: 20px; text-align: center; border-bottom: 2px solid var(--gold); }
        .logo { color: var(--gold); font-size: 1.5rem; font-weight: 900; text-transform: uppercase; }
        .sub-logo { color: #666; font-size: 0.7rem; letter-spacing: 2px; }

        /* CONTAINER */
        .box { padding: 20px; max-width: 500px; margin: 0 auto; }
        .label { color: #888; font-size: 0.8rem; margin-top: 15px; margin-bottom: 5px; font-weight: bold; text-transform: uppercase;}

        /* BOTOES DE DATA */
        .dates { display: flex; gap: 10px; }
        .d-btn { flex: 1; background: var(--gray); border: 1px solid #444; color: #ccc; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; }
        .d-btn.active { background: var(--gold); color: black; font-weight: bold; border-color: var(--gold); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }

        /* INPUTS */
        select, input { width: 100%; padding: 15px; background: var(--gray); border: 1px solid #333; color: white; border-radius: 8px; font-size: 1rem; outline: none; }
        
        /* GRID DE HORARIOS */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 5px; }
        .h-btn { background: var(--gray); border: 1px solid #444; color: white; padding: 12px 5px; border-radius: 6px; text-align: center; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        
        /* ESTADOS DOS BOT√ïES */
        .h-btn.selected { background: var(--gold); color: black; font-weight: bold; border-color: var(--gold); transform: scale(1.05); }
        
        /* AQUI EST√Å A CORRE√á√ÉO VISUAL: RISCADO PARA TUDO QUE √â INDISPON√çVEL */
        .h-btn.disabled { 
            opacity: 0.4; 
            text-decoration: line-through; 
            cursor: not-allowed; 
            background: #1a1a1a; 
            border-color: #333; 
            color: #555;
        }

        /* RODAP√â */
        .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.95); padding: 15px; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .total { font-size: 1.4rem; font-weight: 900; color: var(--gold); margin-left: 20px; }
        .confirm-btn { background: var(--gold); color: black; border: none; padding: 12px 25px; border-radius: 30px; font-weight: 900; font-size: 1rem; margin-right: 20px; cursor: pointer; text-transform: uppercase; }

        /* MODAL COMPROVANTE */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
        .card { background: white; color: black; width: 85%; max-width: 350px; border-radius: 10px; padding: 0; text-align: center; border: 4px solid var(--gold); overflow: hidden; }
        .card-header { background: var(--gold); padding: 15px; font-weight: 900; font-size: 1.2rem; }
        .card-body { padding: 20px; }
        .info-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding: 10px 0; font-size: 0.9rem; }
        .zap-btn { background: var(--green); color: white; text-decoration: none; display: flex; justify-content: center; align-items: center; gap: 10px; padding: 15px; margin: 20px; border-radius: 8px; font-weight: bold; text-transform: uppercase; }
        .close-btn { background: #333; color: white; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo"><i class="fas fa-crown"></i> Imp√©rioCar</div>
        <div class="sub-logo">AGENDAMENTO ONLINE</div>
    </div>

    <div class="box">
        <!-- 1. DATA -->
        <div class="label">1. Escolha o dia</div>
        <div class="dates">
            <div class="d-btn active" id="btnHoje" onclick="mudarDia('hoje')">HOJE<br><small id="txtHoje">--/--</small></div>
            <div class="d-btn" id="btnAmanha" onclick="mudarDia('amanha')">AMANH√É<br><small id="txtAmanha">--/--</small></div>
        </div>

        <!-- 2. VEICULO -->
        <div class="label">2. Seu Ve√≠culo</div>
        <select id="veiculo" onchange="calc()">
            <option value="pequeno">Carro Pequeno (Hatch)</option>
            <option value="medio" selected>Carro M√©dio (Sedan)</option>
            <option value="grande">Carro Grande (SUV)</option>
            <option value="moto">Moto</option>
        </select>

        <!-- 3. SERVI√áO -->
        <div class="label">3. Servi√ßo</div>
        <select id="servico" onchange="calc()">
            <option value="ducha">S√≥ Ducha</option>
            <option value="simples" selected>Lavagem Simples</option>
            <option value="cera">Lavagem com Cera</option>
            <option value="higienizacao">Higieniza√ß√£o</option>
        </select>

        <!-- 4. HORARIOS -->
        <div class="label">4. Hor√°rio</div>
        <div class="grid" id="gridHoras">Carregando...</div>

        <!-- 5. NOME -->
        <div class="label">5. Seu Nome</div>
        <input type="text" id="nome" placeholder="Digite seu nome completo...">
        
        <!-- 6. PAGAMENTO -->
        <div class="label">6. Pagamento</div>
        <select id="pagamento">
            <option>Pix</option>
            <option>Cart√£o</option>
            <option>Dinheiro</option>
        </select>
        
        <div style="text-align: center; margin-top: 20px; font-size: 0.7rem; color: #555;" id="statusSys">...</div>
    </div>

    <div class="footer">
        <div class="total" id="total">R$ 0,00</div>
        <button id="btnConfirmar" class="confirm-btn" onclick="agendar()">CONFIRMAR</button>
    </div>

    <!-- MODAL COMPROVANTE -->
    <div class="modal" id="modalRecibo">
        <div class="card">
            <div class="card-header">‚úÖ AGENDADO!</div>
            <div class="card-body">
                <div class="info-row"><span>Cliente:</span> <strong id="rNome">--</strong></div>
                <div class="info-row"><span>Data:</span> <strong id="rData">--</strong></div>
                <div class="info-row"><span>Hor√°rio:</span> <strong id="rHora">--</strong></div>
                <div class="info-row"><span>Ve√≠culo:</span> <strong id="rCarro">--</strong></div>
                <div class="info-row"><span>Servi√ßo:</span> <strong id="rServico">--</strong></div>
                <div class="info-row"><span>Valor:</span> <strong id="rValor" style="color:green">--</strong></div>
                <div style="margin-top:10px; font-size:0.7rem; color:#888;">Protocolo: <span id="rID">...</span></div>
            </div>
            
            <a href="#" id="linkZap" class="zap-btn">
                <i class="fab fa-whatsapp"></i> Enviar no WhatsApp
            </a>
            
            <button class="close-btn" onclick="location.reload()">FECHAR</button>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const supabaseUrl = 'https://jmivkvtebtjudqhvgc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptaXZrdmV0ZWJ0anVkcWh2dmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MjIzMTYsImV4cCI6MjA4MDE5ODMxNn0.WtPrTn0Kvx6o_h_ZfNoAcQGjNDErr0NqT0wt60YLlo0';
        
        let supabase = null;
        let diaSel = 'hoje';
        let horaSel = null;

        const precos = {
            moto: { ducha: 20, simples: 30, cera: 40, higienizacao: 100 },
            pequeno: { ducha: 30, simples: 45, cera: 60, higienizacao: 200 },
            medio: { ducha: 35, simples: 50, cera: 70, higienizacao: 250 },
            grande: { ducha: 50, simples: 70, cera: 90, higienizacao: 300 }
        };

        window.onload = () => {
            try {
                if(window.supabase) {
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    document.getElementById('statusSys').innerText = "";
                }
            } catch(e) { document.getElementById('statusSys').innerText = "Modo Offline"; }

            atualizarDatas();
            mudarDia('hoje');
            calc();
        };

        function atualizarDatas() {
            const h = new Date();
            const a = new Date(); a.setDate(h.getDate()+1);
            document.getElementById('txtHoje').innerText = `${h.getDate()}/${h.getMonth()+1}`;
            document.getElementById('txtAmanha').innerText = `${a.getDate()}/${a.getMonth()+1}`;
        }

        async function mudarDia(dia) {
            diaSel = dia;
            document.getElementById('btnHoje').className = dia === 'hoje' ? 'd-btn active' : 'd-btn';
            document.getElementById('btnAmanha').className = dia === 'amanha' ? 'd-btn active' : 'd-btn';
            horaSel = null;
            await gerarGrid();
        }

        // --- AQUI EST√Å A L√ìGICA CORRIGIDA DOS HOR√ÅRIOS ---
        async function gerarGrid() {
            const grid = document.getElementById('gridHoras');
            grid.innerHTML = '<div style="color:#888; font-size:0.8rem;">Verificando disponibilidade...</div>';

            const agora = new Date();
            const horaAtual = agora.getHours();
            const minAtual = agora.getMinutes();

            // Busca Ocupados
            let ocupados = [];
            const dataStr = getDataFormatada(diaSel);
            
            if(supabase) {
                try {
                    const { data } = await supabase.from('agendamentos_imperio').select('horario').eq('data_escolhida', dataStr);
                    if(data) ocupados = data.map(x => x.horario);
                } catch(e) {}
            }

            grid.innerHTML = '';
            
            // --- BOT√ÉO ENCAIXE INTELIGENTE ---
            // Se for hoje e j√° passou das 18h (loja fechou), o encaixe tamb√©m fica riscado
            let encaixeDisabled = false;
            if (diaSel === 'hoje' && horaAtual >= 18) {
                encaixeDisabled = true;
            }
            
            const encaixeClass = encaixeDisabled ? 'h-btn disabled' : 'h-btn';
            const encaixeAction = encaixeDisabled ? '' : `onclick="selectHora(this, 'Encaixe')"`;
            const encaixeStyle = encaixeDisabled ? '' : 'border:1px solid var(--gold); color:var(--gold);';
            
            grid.innerHTML += `<div class="${encaixeClass}" style="${encaixeStyle}" ${encaixeAction}>ENCAIXE</div>`;

            // --- LOOP DE HOR√ÅRIOS (08:00 as 18:00) ---
            let min = 8 * 60; 
            while (min < 18 * 60) {
                const h = Math.floor(min / 60);
                const m = min % 60;
                const txt = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                
                let classe = 'h-btn';
                let travado = false;

                // 1. VERIFICA SE PASSOU DA HORA (REL√ìGIO)
                if (diaSel === 'hoje') {
                    // Se a hora do bot√£o for menor que a atual
                    if (h < horaAtual) { 
                        travado = true;
                    }
                    // Se for a mesma hora, mas passou os minutos (ex: agora 14:15, bot√£o 14:00 trava)
                    else if (h === horaAtual && m < minAtual) {
                        travado = true;
                    }
                }

                // 2. VERIFICA SE TEM GENTE (BANCO DE DADOS)
                if (ocupados.includes(txt)) {
                    travado = true;
                }

                // APLICA O ESTILO "RISCADO" (DISABLED)
                if (travado) {
                    classe += ' disabled';
                }

                const action = travado ? '' : `onclick="selectHora(this, '${txt}')"`;
                grid.innerHTML += `<div class="${classe}" ${action}>${txt}</div>`;
                
                min += 60; // Intervalos de 1 hora
            }
        }

        function selectHora(el, hora) {
            document.querySelectorAll('.h-btn').forEach(b => {
                // Remove sele√ß√£o apenas dos ativos
                if(!b.classList.contains('disabled')) b.classList.remove('selected');
            });
            el.classList.add('selected');
            horaSel = hora;
        }

        function calc() {
            const v = document.getElementById('veiculo').value;
            const s = document.getElementById('servico').value;
            const preco = precos[v][s];
            document.getElementById('total').innerText = `R$ ${preco},00`;
        }

        function getDataFormatada(dia) {
            const d = new Date();
            if(dia === 'amanha') d.setDate(d.getDate()+1);
            return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}`;
        }

        async function agendar() {
            const btn = document.getElementById('btnConfirmar');
            const nome = document.getElementById('nome').value;

            if(!horaSel) return alert('Escolha um hor√°rio dispon√≠vel!');
            if(!nome) return alert('Digite seu nome!');

            btn.innerText = "‚è≥ SALVANDO...";
            btn.disabled = true;

            const veiculo = document.getElementById('veiculo').options[document.getElementById('veiculo').selectedIndex].text;
            const servico = document.getElementById('servico').options[document.getElementById('servico').selectedIndex].text;
            const valor = document.getElementById('total').innerText;
            const dataStr = getDataFormatada(diaSel);
            const pag = document.getElementById('pagamento').value;

            // SALVA NO BANCO (EM SEGUNDO PLANO)
            let idGerado = "APP-" + Math.floor(Math.random() * 10000);
            
            if(supabase) {
                try {
                    const { data } = await supabase.from('agendamentos_imperio').insert({
                        cliente_nome: nome,
                        data_escolhida: dataStr,
                        horario: horaSel,
                        tamanho_carro: veiculo,
                        servico_nome: servico,
                        valor_cobrado: parseFloat(valor.replace('R$ ','').replace(',','.')),
                        forma_pagamento: pag
                    }).select();
                    
                    if(data && data[0]) idGerado = data[0].id.split('-')[0].toUpperCase().substring(0, 6);
                } catch(e) {}
            }

            // PREENCHE COMPROVANTE
            document.getElementById('rNome').innerText = nome;
            document.getElementById('rData').innerText = dataStr;
            document.getElementById('rHora').innerText = horaSel;
            document.getElementById('rCarro').innerText = veiculo;
            document.getElementById('rServico').innerText = servico;
            document.getElementById('rValor').innerText = valor;
            document.getElementById('rID').innerText = idGerado;

            // GERA LINK ZAP
            const msgZap = `üßæ *COMPROVANTE*\nüë§ ${nome}\nüìÖ ${dataStr} √†s ${horaSel}\nüöó ${veiculo}\nüöø ${servico}\nüí∞ ${valor}\nüÜî ${idGerado}`;
            document.getElementById('linkZap').href = `https://wa.me/5511960671570?text=${encodeURIComponent(msgZap)}`;

            // ABRE MODAL
            document.getElementById('modalRecibo').style.display = 'flex';
            btn.innerText = "CONFIRMAR";
            btn.disabled = false;
        }
    </script>
</body>
</html>
