<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imp√©rioCar | Agendamento</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --gold: #FFD700; --black: #111; --gray: #222; --green: #25D366; }
        * { box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--black); color: white; margin: 0; padding-bottom: 90px; }

        .header { background: #000; padding: 20px; text-align: center; border-bottom: 2px solid var(--gold); }
        .logo { color: var(--gold); font-size: 1.5rem; font-weight: 900; text-transform: uppercase; }
        
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .section-title { color: var(--gold); font-size: 0.9rem; font-weight: 800; margin: 20px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .date-selector { display: flex; gap: 10px; }
        .date-btn { flex: 1; padding: 15px; background: var(--gray); border: 1px solid #444; color: #ccc; border-radius: 8px; cursor: pointer; text-align: center; }
        .date-btn.selected { background: var(--gold); color: black; font-weight: bold; border-color: var(--gold); }
        
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .time-btn { padding: 12px 5px; background: var(--gray); border: 1px solid #444; color: white; border-radius: 6px; text-align: center; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .time-btn.selected { background: var(--gold); color: black; font-weight: bold; transform: scale(1.05); }
        
        /* ESTILOS DE BLOQUEIO */
        .time-btn.disabled { background: #151515; color: #444; border-color: #222; text-decoration: line-through; pointer-events: none; }
        .time-btn.occupied { background: #3a0000; color: #ff5555; border-color: #500; text-decoration: line-through; pointer-events: none; }

        select, input { width: 100%; padding: 15px; background: var(--gray); border: 1px solid #333; color: white; border-radius: 8px; font-size: 1rem; margin-bottom: 10px; outline: none; }
        
        .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.95); padding: 15px; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .confirm-btn { background: var(--gold); color: black; border: none; padding: 12px 25px; border-radius: 30px; font-weight: 900; font-size: 1rem; margin-right: 20px; cursor: pointer; }

        /* MODAL */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
        .card { background: white; color: black; width: 85%; max-width: 350px; border-radius: 10px; overflow: hidden; border: 4px solid var(--gold); text-align: center; }
        .card-header { background: var(--gold); padding: 15px; font-weight: 900; font-size: 1.2rem; }
        .zap-btn { background: var(--green); color: white; text-decoration: none; display: flex; justify-content: center; align-items: center; gap: 10px; padding: 15px; margin: 20px; border-radius: 8px; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo"><i class="fas fa-crown"></i> Imp√©rioCar</div>
    </div>

    <div class="container">
        <!-- DATA -->
        <div class="section-title">1. ESCOLHA O DIA</div>
        <div class="date-selector">
            <button class="date-btn selected" id="btnHoje" onclick="mudarDia('hoje')">HOJE<br><span id="labelToday">--/--</span></button>
            <button class="date-btn" id="btnTomorrow" onclick="mudarData('amanha')">AMANH√É<br><span id="labelTomorrow">--/--</span></button>
        </div>

        <!-- VEICULO -->
        <div class="section-title">2. VE√çCULO</div>
        <select id="carSize" onchange="calcular()">
            <option value="pequeno">Carro Pequeno</option>
            <option value="medio" selected>Carro M√©dio</option>
            <option value="grande">Carro Grande / SUV</option>
            <option value="moto">Moto</option>
        </select>

        <!-- HORARIO -->
        <div class="section-title">3. HOR√ÅRIO</div>
        <div class="time-grid" id="gridHorarios">Carregando...</div>

        <!-- SERVI√áO -->
        <div class="section-title">4. SERVI√áO</div>
        <select id="servico" onchange="calcular()">
            <option value="ducha">S√≥ Ducha</option>
            <option value="simples" selected>Lavagem Simples</option>
            <option value="cera">Lavagem com Cera</option>
            <option value="higienizacao">Higieniza√ß√£o</option>
        </select>

        <!-- NOME -->
        <div class="section-title">5. SEU NOME</div>
        <input type="text" id="nomeCliente" placeholder="Digite seu nome...">
        
        <!-- PAGAMENTO -->
        <div class="section-title">6. PAGAMENTO</div>
        <select id="pagamento">
            <option>Pix</option>
            <option>Cart√£o</option>
            <option>Dinheiro</option>
        </select>
        
        <div style="height: 20px;"></div>
    </div>

    <div class="sticky-footer">
        <div style="color:#ccc; margin-left: 20px;">Total: <span id="valorTotal" style="color:var(--gold); font-weight:900; font-size:1.3rem;">R$ 0,00</span></div>
        <button id="btnConfirmar" class="confirm-btn" onclick="agendar()">CONFIRMAR</button>
    </div>

    <!-- MODAL -->
    <div class="modal" id="modalRecibo">
        <div class="card">
            <div class="card-header">‚úÖ AGENDADO!</div>
            <div style="padding: 20px; font-size: 0.9rem; line-height: 1.6;">
                <div>Cliente: <strong id="rNome">--</strong></div>
                <div>Data: <strong id="rData">--</strong></div>
                <div>Hor√°rio: <strong id="rHora">--</strong></div>
                <div>Valor: <strong id="rValor" style="color:green">--</strong></div>
                <div style="margin-top:10px; font-size:0.7rem; color:#888;">Protocolo: <span id="rID">...</span></div>
            </div>
            <a href="#" id="linkZap" class="zap-btn"><i class="fab fa-whatsapp"></i> ENVIAR COMPROVANTE</a>
            <button onclick="location.reload()" style="background:#333; color:white; border:none; padding:15px; width:100%; cursor:pointer;">FECHAR</button>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const supabaseUrl = 'https://jmivkvtebtjudqhvgc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptaXZrdmV0ZWJ0anVkcWh2dmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MjIzMTYsImV4cCI6MjA4MDE5ODMxNn0.WtPrTn0Kvx6o_h_ZfNoAcQGjNDErr0NqT0wt60YLlo0';
        let supabase = null;
        try { supabase = window.supabase.createClient(supabaseUrl, supabaseKey); } catch(e){}

        // --- DADOS ---
        let diaSel = 'hoje';
        let horaSel = null;
        const precos = {
            moto: { ducha: 20, simples: 30, cera: 40, higienizacao: 100 },
            pequeno: { ducha: 30, simples: 45, cera: 60, higienizacao: 200 },
            medio: { ducha: 35, simples: 50, cera: 70, higienizacao: 250 },
            grande: { ducha: 50, simples: 70, cera: 90, higienizacao: 300 }
        };

        // --- INICIALIZAR ---
        window.onload = () => {
            renderDatas();
            mudarDia('hoje');
            calcular();
        };

        function renderDatas() {
            const h = new Date();
            const a = new Date(); a.setDate(h.getDate()+1);
            document.getElementById('labelToday').innerText = `${h.getDate()}/${h.getMonth()+1}`;
            document.getElementById('labelTomorrow').innerText = `${a.getDate()}/${a.getMonth()+1}`;
        }

        // --- L√ìGICA DE BLOQUEIO (AGORA VAI FUNCIONAR!) ---
        async function mudarDia(dia) {
            diaSel = dia;
            document.getElementById('btnHoje').className = dia === 'hoje' ? 'date-btn selected' : 'date-btn';
            document.getElementById('btnTomorrow').className = dia === 'amanha' ? 'date-btn selected' : 'date-btn';
            horaSel = null;
            await gerarGrid();
        }

        async function gerarGrid() {
            const grid = document.getElementById('gridHorarios');
            grid.innerHTML = '<div style="color:#888;">Verificando disponibilidade...</div>';

            const agora = new Date();
            const horaAtual = agora.getHours();
            const dataStr = getDataFormatada(diaSel);
            
            // 1. LER BANCO DE DADOS (Agora funciona porque rodamos o SQL)
            let ocupados = [];
            if(supabase) {
                try {
                    const { data } = await supabase.from('agendamentos_imperio')
                        .select('horario')
                        .eq('data_escolhida', dataStr); // Filtra pela data
                    
                    if(data) ocupados = data.map(x => x.horario);
                } catch(e) { console.log(e); }
            }

            grid.innerHTML = '';

            // Bot√£o Encaixe (Trava se j√° passou das 18h de hoje)
            let encaixeTravado = (diaSel === 'hoje' && horaAtual >= 18);
            let encaixeClass = encaixeTravado ? 'time-btn disabled' : 'time-btn';
            let encaixeClick = encaixeTravado ? '' : `onclick="selectHora(this, 'Encaixe')"`;
            grid.innerHTML += `<div class="${encaixeClass}" style="border-color:var(--gold); color:var(--gold);" ${encaixeClick}>ENCAIXE</div>`;

            // Loop das Horas
            let min = 8 * 60; // 08:00
            while(min < 18 * 60) {
                const h = Math.floor(min/60);
                const m = min % 60;
                const txt = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                
                let classe = 'time-btn';
                let travado = false;

                // A. J√° passou da hora? (S√≥ se for hoje)
                if (diaSel === 'hoje') {
                    if (h < horaAtual || (h === horaAtual && m < agora.getMinutes())) {
                        travado = true;
                    }
                }

                // B. J√° tem gente? (Olha a lista do banco)
                if (ocupados.includes(txt)) {
                    travado = true;
                    classe += ' occupied'; // Fica vermelho
                } else if (travado) {
                    classe += ' disabled'; // Fica cinza
                }

                const action = travado ? '' : `onclick="selectHora(this, '${txt}')"`;
                grid.innerHTML += `<div class="${classe}" ${action}>${txt}</div>`;
                
                min += 60; 
            }
        }

        function selectHora(el, hora) {
            document.querySelectorAll('.time-btn').forEach(b => {
                if(!b.classList.contains('disabled') && !b.classList.contains('occupied')) b.classList.remove('selected');
            });
            el.classList.add('selected');
            horaSel = hora;
        }

        // --- SALVAR E GERAR COMPROVANTE ---
        async function agendar() {
            const btn = document.getElementById('btnConfirmar');
            const nome = document.getElementById('nomeCliente').value;

            if(!horaSel) return alert('Selecione um hor√°rio dispon√≠vel!');
            if(!nome) return alert('Digite seu nome!');

            btn.innerText = "‚è≥ SALVANDO...";
            btn.disabled = true;

            const tamanho = document.getElementById('carSize').value;
            const servico = document.getElementById('servico').options[document.getElementById('servico').selectedIndex].text;
            const valor = document.getElementById('valorTotal').innerText;
            const dataStr = getDataFormatada(diaSel);
            const pag = document.getElementById('pagamento').value;

            // 1. Salva no Banco (Para bloquear para os outros)
            let idGerado = "OFF-" + Math.floor(Math.random()*1000);
            
            if(supabase) {
                try {
                    // Verifica√ß√£o final antes de salvar
                    if (horaSel !== 'Encaixe') {
                        const { data: jaTem } = await supabase.from('agendamentos_imperio').select('id').eq('data_escolhida', dataStr).eq('horario', horaSel);
                        if (jaTem && jaTem.length > 0) {
                            alert('‚ö†Ô∏è Vaga preenchida agora mesmo! Atualizando tela...');
                            await gerarGrid(); 
                            btn.innerText = "CONFIRMAR"; btn.disabled = false;
                            return;
                        }
                    }

                    const { data } = await supabase.from('agendamentos_imperio').insert({
                        cliente_nome: nome,
                        data_escolhida: dataStr,
                        horario: horaSel,
                        tamanho_carro: tamanho,
                        servico_nome: servico,
                        valor_cobrado: parseFloat(valor.replace('R$ ','').replace(',','.')),
                        forma_pagamento: pag
                    }).select();
                    
                    if(data && data[0]) idGerado = data[0].id.split('-')[0].toUpperCase().substring(0, 6);
                } catch(e) {}
            }

            // 2. Mostra Comprovante
            document.getElementById('rNome').innerText = nome;
            document.getElementById('rData').innerText = dataStr;
            document.getElementById('rHora').innerText = horaSel;
            document.getElementById('rValor').innerText = valor;
            document.getElementById('rID').innerText = idGerado;

            const msgZap = `üßæ *COMPROVANTE*\nüë§ ${nome}\nüìÖ ${dataStr} √†s ${horaSel}\nüöó ${tamanho}\nüöø ${servico}\nüí∞ ${valor}\nüÜî ${idGerado}`;
            document.getElementById('linkZap').href = `https://wa.me/5511960671570?text=${encodeURIComponent(msgZap)}`;

            document.getElementById('modalRecibo').style.display = 'flex';
            btn.innerText = "CONFIRMAR"; btn.disabled = false;
        }

        // --- EXTRAS ---
        function calcular() {
            const tam = document.getElementById('carSize').value;
            const svc = document.getElementById('servico').value;
            
            let svcKey = 'simples';
            if (svc.includes('ducha')) svcKey = 'ducha';
            if (svc.includes('cera')) svcKey = 'cera';
            if (svc.includes('higienizacao')) svcKey = 'higienizacao';

            const val = precos[tam][svcKey] || 0;
            document.getElementById('valorTotal').innerText = `R$ ${val},00`;
        }

        function getDataFormatada(dia) {
            const d = new Date();
            if(dia === 'amanha') d.setDate(d.getDate()+1);
            return `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}`;
        }
    </script>
</body>
</html>
