<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imp√©rioCar-01 | Agendamento VIP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <!-- CONEX√ÉO BANCO DE DADOS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --gold: #FFD700; --gold-dark: #B8860B; --black: #0a0a0a;
            --gray-dark: #141414; --gray-light: #2a2a2a;
            --whatsapp: #25D366; --success: #4CAF50; --danger: #ff4444;
            --warning: #ff9800; --info: #2196F3;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--black); color: white; padding-bottom: 140px; }
        
        /* CABE√áALHO */
        .header { background: linear-gradient(to bottom, rgba(0,0,0,0.7), var(--black)), url('https://images.unsplash.com/photo-1601362840469-51e4d8d58785?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'); background-size: cover; background-position: center; text-align: center; padding: 40px 20px 20px 20px; border-bottom: 3px solid var(--gold); }
        .logo h1 { color: var(--gold); font-weight: 900; font-size: 1.8rem; text-transform: uppercase; }
        .logo p { font-size: 0.8rem; letter-spacing: 2px; color: #ddd; }
        
        .container { width: 100%; max-width: 600px; margin: 0 auto; padding: 15px; }
        
        /* GALERIA */
        .gallery-container { position: relative; width: 100%; height: 220px; border-radius: 10px; overflow: hidden; border: 2px solid var(--gold); margin-bottom: 25px; background: #000; }
        .gallery-slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 1s; object-fit: cover; }
        .gallery-slide.active { opacity: 1; }
        .gallery-caption { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: var(--gold); padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }

        /* SE√á√ïES E BOT√ïES */
        .section-title { font-size: 1rem; color: var(--gold); margin: 25px 0 10px 0; text-transform: uppercase; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .section-title::after { content: ''; flex: 1; height: 1px; background: #333; }
        
        .date-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .date-btn { flex: 1; padding: 15px; background-color: var(--gray-light); border: 1px solid #444; color: #ccc; border-radius: 8px; font-weight: bold; font-size: 0.9rem; text-transform: uppercase; cursor: pointer; }
        .date-btn.selected { background-color: var(--gold); color: var(--black); border-color: var(--gold); }
        
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; min-height: 80px; }
        .time-btn { background-color: var(--gray-light); border: 1px solid #444; color: #ccc; padding: 12px 5px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; text-align: center; transition: all 0.3s; position: relative; }
        .time-btn.selected { background-color: var(--gold); color: var(--black); font-weight: 900; border-color: var(--gold); }
        .time-btn.disabled { background-color: #111; color: #444; border-color: #222; cursor: not-allowed; text-decoration: line-through; }
        .time-btn.booked { background-color: rgba(244, 67, 54, 0.3); color: #ff8a80; border-color: #f44336; cursor: not-allowed; }
        .time-btn.booked::after { content: ' ‚úì AGENDADO'; font-size: 0.7rem; color: #f44336; font-weight: bold; position: absolute; bottom: 2px; right: 5px; }
        .time-btn.reserving { background-color: rgba(255, 152, 0, 0.3); color: #ffcc80; border-color: #ff9800; cursor: not-allowed; animation: pulse 2s infinite; }
        .time-btn.reserving::after { content: ' ‚è≥ AGENDANDO...'; font-size: 0.7rem; color: #ff9800; font-weight: bold; position: absolute; bottom: 2px; right: 5px; }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        select, .payment-select { width: 100%; padding: 15px; background-color: var(--gray-light); border: 1px solid #333; color: white; border-radius: 8px; font-size: 1rem; margin-bottom: 10px; }
        .service-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--gray-light); padding: 15px; border-radius: 10px; border: 1px solid #333; margin-bottom: 10px; }
        .service-item input { transform: scale(1.3); accent-color: var(--gold); margin-right: 10px;}
        .price-tag { color: var(--gold); font-weight: bold; }
        
        .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(0,0,0,0.95); padding: 15px; border-top: 1px solid #333; display: flex; flex-direction: column; align-items: center; z-index: 100; }
        .btn-agendar { background-color: var(--success); color: white; text-decoration: none; padding: 16px; border-radius: 50px; font-weight: 800; width: 100%; text-align: center; display: block; border: none; font-size: 1rem; cursor: pointer; transition: all 0.3s; }
        .btn-agendar:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn-agendar.loading { position: relative; padding-right: 50px; }
        .btn-agendar.loading::after { content: ''; position: absolute; right: 20px; top: 50%; width: 20px; height: 20px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; transform: translateY(-50%); }
        
        @keyframes spin {
            to { transform: translateY(-50%) rotate(360deg); }
        }
        
        /* MENSAGENS */
        .message { padding: 15px; border-radius: 10px; margin: 15px 0; text-align: center; display: none; animation: fadeIn 0.5s; }
        .message.success { background-color: rgba(76, 175, 80, 0.2); border: 1px solid var(--success); color: #a5d6a7; }
        .message.error { background-color: rgba(244, 67, 54, 0.2); border: 1px solid var(--danger); color: #ffabab; }
        .message.info { background-color: rgba(33, 150, 243, 0.2); border: 1px solid var(--info); color: #90caf9; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* MODAL DE CONFIRMA√á√ÉO */
        .confirmation-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; align-items:center; justify-content:center; animation: fadeIn 0.3s; }
        .confirmation-content { background:#1a1a1a; padding:25px; border:2px solid var(--gold); width:90%; max-width:400px; text-align:center; border-radius:10px; }
        
        /* LOADING OVERLAY */
        .loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; align-items:center; justify-content:center; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--gray-light); border-top: 5px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        
        /* STATUS LEGEND */
        .status-legend { display: flex; justify-content: space-between; margin: 10px 0 20px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; }
        .status-item { display: flex; align-items: center; gap: 5px; }
        .status-color { width: 15px; height: 15px; border-radius: 3px; }
        .status-text { font-size: 0.7rem; color: #aaa; }
        
        /* ADMIN MODAL */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; align-items:center; justify-content:center; }
        .modal-content { background:#1a1a1a; padding:20px; border:2px solid var(--gold); width:90%; max-width:400px; text-align:center; border-radius:10px; max-height: 80vh; overflow-y: auto;}
        .admin-input { width:100%; padding:10px; margin:10px 0; background:#333; border:1px solid #555; color:white; }
        .admin-btn { background:var(--gold); border:none; padding:10px; width:100%; font-weight:bold; margin-top:5px; cursor:pointer; }
        
        .admin-photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        .admin-photo-item { position: relative; height: 60px; }
        .admin-photo-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; border: 1px solid #444; }
        .delete-btn { position: absolute; top:0; right:0; background:red; color:white; border:none; width:20px; height:20px; font-size:10px; cursor:pointer;}
    </style>
</head>
<body>

    <div class="header">
        <div class="logo" id="crownLogo">
            <i class="fas fa-crown" style="color: var(--gold); font-size: 2.5rem; margin-bottom: 10px;"></i>
            <h1>Imp√©rioCar-01</h1>
            <p>LAVA-R√ÅPIDO & EST√âTICA</p>
        </div>
    </div>

    <div class="container">
        <!-- MENSAGEM -->
        <div id="messageContainer" class="message" style="display: none;"></div>
        
        <!-- LEGENDA DE STATUS -->
        <div class="status-legend">
            <div class="status-item">
                <div class="status-color" style="background-color: var(--gold);"></div>
                <div class="status-text">DISPON√çVEL</div>
            </div>
            <div class="status-item">
                <div class="status-color" style="background-color: #ff9800;"></div>
                <div class="status-text">AGENDANDO</div>
            </div>
            <div class="status-item">
                <div class="status-color" style="background-color: #f44336;"></div>
                <div class="status-text">AGENDADO</div>
            </div>
        </div>
        
        <!-- VITRINE -->
        <div class="section-title">VITRINE (VE√çCULOS PRONTOS)</div>
        <div class="gallery-container" id="galleryContainer"></div>

        <div style="background:rgba(184,134,11,0.15); border:1px solid var(--gold-dark); padding:15px; border-radius:8px; font-size:0.85rem; margin-bottom:20px; text-align:center; color:#ddd;">
            <i class="fas fa-shield-alt" style="margin-right:5px; color:var(--gold);"></i> Sistema de agendamento <strong>PROFISSIONAL</strong> - Hor√°rios atualizados em tempo real
        </div>

        <div class="section-title">ESCOLHA O DIA</div>
        <div class="date-selector">
            <button class="date-btn selected" id="btnToday" onclick="mudarData('hoje')">HOJE<br><span id="labelToday" style="font-size:0.7rem">--/--</span></button>
            <button class="date-btn" id="btnTomorrow" onclick="mudarData('amanha')">AMANH√É<br><span id="labelTomorrow" style="font-size:0.7rem">--/--</span></button>
        </div>

        <div class="section-title">VE√çCULO</div>
        <select id="carSize" onchange="calcular()">
            <option value="pequeno">Carro Pequeno (Hatch)</option>
            <option value="medio" selected>Carro M√©dio (Sedan)</option>
            <option value="grande">Carro Grande (SUV/Pick-up)</option>
            <option value="moto">Moto</option>
        </select>

        <div class="section-title">HOR√ÅRIO</div>
        <div class="time-grid" id="gridHorarios"></div>
        
        <div class="section-title">SERVI√áO</div>
        <div id="listaServicos"></div>

        <div class="section-title">PAGAMENTO</div>
        <select id="pagamento" onchange="calcular()">
            <option value="Pix">Pix</option>
            <option value="Cart√£o">Cart√£o Cr√©dito/D√©bito</option>
            <option value="Dinheiro">Dinheiro</option>
        </select>
        
        <div style="height: 20px;"></div>
        <div style="text-align:center; font-size:0.8rem; color:#666;">Rua Giovanni Segantini, 257A<br>Jos√© Bonif√°cio - SP</div>
    </div>

    <div class="sticky-footer">
        <div style="color:#ccc; margin-bottom:5px;">Total: <span id="valorTotal" style="color:var(--gold); font-weight:900; font-size:1.3rem;">R$ 0,00</span></div>
        <button id="btnAgendar" class="btn-agendar">CONFIRMAR AGENDAMENTO</button>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div style="margin-top:20px; color:var(--gold); font-weight:600;">Processando agendamento...</div>
    </div>

    <!-- MODAL DE CONFIRMA√á√ÉO -->
    <div id="modalConfirmacao" class="confirmation-modal">
        <div class="confirmation-content">
            <i class="fas fa-check-circle" style="color:var(--success); font-size:3.5rem; margin-bottom:15px;"></i>
            <h3 style="color:var(--gold); margin-bottom:10px;">AGENDAMENTO CONFIRMADO!</h3>
            <div id="confirmacaoDetalhes" style="margin-bottom:20px; color:#ccc; line-height:1.5; text-align:left; background:rgba(255,215,0,0.1); padding:15px; border-radius:8px;"></div>
            <div style="display:flex; gap:10px; flex-direction: column;">
                <button onclick="enviarWhatsApp()" class="admin-btn" style="background:var(--whatsapp); color:white;">
                    <i class="fab fa-whatsapp"></i> RECEBER NO WHATSAPP
                </button>
                <button onclick="fecharConfirmacao()" class="admin-btn" style="background:#333; color:white;">
                    <i class="fas fa-times"></i> FECHAR
                </button>
            </div>
        </div>
    </div>

    <!-- PAIN√âIS ADMIN -->
    <div id="modalLogin" class="modal-overlay">
        <div class="modal-content">
            <h3>√ÅREA ADMIN</h3>
            <input type="password" id="senhaAdmin" class="admin-input" placeholder="Senha">
            <button onclick="logarAdmin()" class="admin-btn">ENTRAR</button>
            <button onclick="document.getElementById('modalLogin').style.display='none'" class="admin-btn" style="background:#444; color:white;">FECHAR</button>
        </div>
    </div>
    
    <div id="painelAdmin" class="modal-overlay">
        <div class="modal-content">
            <h3>PAINEL DE CONTROLE</h3>
            <div style="text-align:left; border-bottom:1px solid #444; padding-bottom:15px; margin-bottom:15px;">
                <h4 style="color:white; margin-bottom:5px;">üì∏ Fotos da Vitrine</h4>
                <label for="fileInput" class="admin-btn" style="background:#444; color:white; font-size:0.9rem;">
                    <i class="fas fa-images"></i> ADICIONAR FOTOS
                </label>
                <input type="file" id="fileInput" accept="image/*" multiple style="display:none;" onchange="handleFileUpload(this)">
                <div id="adminPhotoGrid" class="admin-photo-grid"></div>
            </div>
            <div id="editorPrecos" style="text-align:left; max-height:200px; overflow-y:scroll; border-bottom:1px solid #444; margin-bottom:10px;"></div>
            <button onclick="salvarPrecos()" class="admin-btn">SALVAR ALTERA√á√ïES</button>
            <button onclick="document.getElementById('painelAdmin').style.display='none'" class="admin-btn" style="background:#c00; color:white;">SAIR</button>
        </div>
    </div>

    <script>
        // ======================================================
        // 1. CONFIGURA√á√ÉO SUPABASE
        // ======================================================
        const supabaseUrl = 'https://jmivkvtebtjudqhvgc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImptaXZrdmV0ZWJ0anVkcWh2dmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2MjIzMTYsImV4cCI6MjA4MDE5ODMxNn0.WtPrTn0Kvx6o_h_ZfNoAcQGjNDErr0NqT0wt60YLlo0';
        
        let supabase = null;
        try { 
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            console.log("Supabase conectado com sucesso");
        } catch (e) { 
            console.error("Erro Supabase", e);
        }

        // ======================================================
        // 2. VARI√ÅVEIS GLOBAIS
        // ======================================================
        let diaSelecionado = 'hoje';
        let horaSelecionada = null;
        let ultimoAgendamento = null;
        let horariosOcupados = {};
        let reservasTemporarias = {};
        let sessaoId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        const defaultPrices = {
            moto: { ducha: 20, simples: 30, cera: 40, higienizacao: 100 },
            pequeno: { ducha: 30, simples: 45, cera: 60, higienizacao: 200 },
            medio: { ducha: 35, simples: 50, cera: 70, higienizacao: 250 },
            grande: { ducha: 50, simples: 70, cera: 90, higienizacao: 300 }
        };
        const defaultPhotos = [
            "https://images.unsplash.com/photo-1601362840469-51e4d8d58785?w=600&q=80",
            "https://images.unsplash.com/photo-1520340356584-7c903ccf70dc?w=600&q=80"
        ];
        
        let precos = JSON.parse(localStorage.getItem('precosImperio')) || defaultPrices;
        let galleryPhotos = JSON.parse(localStorage.getItem('imperioPhotos')) || defaultPhotos;
        let currentSlide = 0;
        let slideInterval;
        
        const servicosOpcoes = [
            { id: 'ducha', nome: 'S√≥ Ducha', desc: 'Externa R√°pida' },
            { id: 'simples', nome: 'Lavagem Simples', desc: 'Int/Ext + Aspirar' },
            { id: 'cera', nome: 'Lavagem c/ Cera', desc: 'Completa + Cera' },
            { id: 'higienizacao', nome: 'Higieniza√ß√£o', desc: 'Interna Profunda' }
        ];

        // ======================================================
        // 3. SISTEMA DE BLOQUEIO DE HOR√ÅRIOS
        // ======================================================
        // Esta fun√ß√£o cria um lock no hor√°rio enquanto est√° sendo agendado
        async function bloquearHorario(dataStr, horario) {
            const chave = `${dataStr}|${horario}`;
            
            // Verificar se j√° est√° bloqueado
            if (reservasTemporarias[chave]) {
                const diff = Date.now() - reservasTemporarias[chave].timestamp;
                // Se o bloqueio tem mais de 3 minutos, liberar
                if (diff < 180000) { // 3 minutos
                    return false;
                }
            }
            
            // Criar novo bloqueio
            reservasTemporarias[chave] = {
                timestamp: Date.now(),
                sessaoId: sessaoId
            };
            
            // Atualizar display
            atualizarDisplayHorarios();
            return true;
        }

        function liberarHorario(dataStr, horario) {
            const chave = `${dataStr}|${horario}`;
            delete reservasTemporarias[chave];
            atualizarDisplayHorarios();
        }

        function verificarHorarioBloqueado(dataStr, horario) {
            const chave = `${dataStr}|${horario}`;
            if (!reservasTemporarias[chave]) return false;
            
            const diff = Date.now() - reservasTemporarias[chave].timestamp;
            if (diff > 180000) { // 3 minutos
                delete reservasTemporarias[chave];
                return false;
            }
            
            return reservasTemporarias[chave].sessaoId !== sessaoId;
        }

        // ======================================================
        // 4. INICIALIZAR
        // ======================================================
        window.onload = async function() {
            console.log("Iniciando sistema de agendamento...");
            initGallery();
            renderizarDatas();
            renderizarServicos();
            
            // Carregar hor√°rios ocupados
            await carregarHorariosOcupados();
            gerarHorariosSimples();
            
            calcular();
            initAdminTrigger();
            
            // Configurar bot√£o de agendamento
            const btn = document.getElementById('btnAgendar');
            if(btn) {
                btn.onclick = iniciarAgendamento;
            }
            
            // Limpar bloqueios antigos a cada minuto
            setInterval(limparBloqueiosAntigos, 60000);
            
            // Atualizar hor√°rios a cada 30 segundos
            setInterval(async () => {
                await carregarHorariosOcupados();
                atualizarDisplayHorarios();
            }, 30000);
            
            console.log("Sistema pronto para agendamentos");
        };

        function limparBloqueiosAntigos() {
            const agora = Date.now();
            for (const chave in reservasTemporarias) {
                if (agora - reservasTemporarias[chave].timestamp > 180000) { // 3 minutos
                    delete reservasTemporarias[chave];
                }
            }
        }

        // ======================================================
        // 5. FUN√á√ïES DE AGENDAMENTO - SISTEMA PROFISSIONAL
        // ======================================================
        async function iniciarAgendamento(e) {
            if (e) e.preventDefault();
            
            // Valida√ß√£o b√°sica
            if (!horaSelecionada && horaSelecionada !== 'Encaixe') {
                mostrarMensagem('error', '‚ö†Ô∏è Selecione um hor√°rio para continuar');
                return;
            }

            const dataStr = getDataFormatada(diaSelecionado);
            const horario = horaSelecionada;

            // Verificar disponibilidade
            if (horario !== 'Encaixe') {
                // Verificar se j√° est√° agendado
                if (verificarHorarioOcupado(dataStr, horario)) {
                    mostrarMensagem('error', '‚ùå Este hor√°rio j√° foi agendado');
                    return;
                }
                
                // Verificar se est√° sendo agendado por outra pessoa
                if (verificarHorarioBloqueado(dataStr, horario)) {
                    mostrarMensagem('error', '‚è≥ Este hor√°rio est√° sendo reservado');
                    return;
                }
                
                // Tentar bloquear o hor√°rio
                const bloqueado = await bloquearHorario(dataStr, horario);
                if (!bloqueado) {
                    mostrarMensagem('error', '‚ùå N√£o foi poss√≠vel reservar este hor√°rio');
                    return;
                }
            }

            // Mostrar loading
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                // Processar agendamento
                const sucesso = await processarAgendamento(dataStr, horario);
                
                if (sucesso) {
                    // Sucesso - mostrar confirma√ß√£o
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        mostrarConfirmacao();
                    }, 1000);
                } else {
                    // Falha
                    document.getElementById('loadingOverlay').style.display = 'none';
                    if (horario !== 'Encaixe') {
                        liberarHorario(dataStr, horario);
                    }
                }
            } catch (error) {
                console.error("Erro no agendamento:", error);
                document.getElementById('loadingOverlay').style.display = 'none';
                mostrarMensagem('error', '‚ùå Erro ao processar agendamento');
                if (horario !== 'Encaixe') {
                    liberarHorario(dataStr, horario);
                }
            }
        }

        async function processarAgendamento(dataStr, horario) {
            try {
                // Coletar dados do formul√°rio
                const tamanho = document.getElementById('carSize').value;
                const servicoRadio = document.querySelector('input[name="servico"]:checked');
                const servicoId = servicoRadio ? servicoRadio.value : 'simples';
                const servico = servicosOpcoes.find(s => s.id === servicoId);
                const valorTotal = document.getElementById('valorTotal').innerText;
                const pag = document.getElementById('pagamento').value;
                
                // Para hor√°rios normais, verificar disponibilidade final
                if (horario !== 'Encaixe') {
                    const disponivel = await verificarDisponibilidadeFinal(dataStr, horario);
                    if (!disponivel) {
                        mostrarMensagem('error', '‚ùå Hor√°rio n√£o dispon√≠vel');
                        return false;
                    }
                }
                
                // Salvar no banco de dados
                const agendamentoId = await salvarAgendamentoNoBanco({
                    data_escolhida: dataStr,
                    horario: horario,
                    tamanho_carro: tamanho,
                    servico_nome: servico.nome,
                    valor_cobrado: parseFloat(valorTotal.replace('R$ ', '').replace(',', '.')),
                    forma_pagamento: pag
                });
                
                if (!agendamentoId) {
                    mostrarMensagem('error', '‚ùå Erro ao salvar agendamento');
                    return false;
                }
                
                // Atualizar cache local
                if (!horariosOcupados[dataStr]) {
                    horariosOcupados[dataStr] = {};
                }
                horariosOcupados[dataStr][horario] = true;
                
                // Limpar sele√ß√£o
                horaSelecionada = null;
                document.querySelectorAll('.time-btn.selected').forEach(b => b.classList.remove('selected'));
                
                // Atualizar display
                atualizarDisplayHorarios();
                
                return true;
                
            } catch (error) {
                console.error("Erro ao processar agendamento:", error);
                return false;
            }
        }

        async function verificarDisponibilidadeFinal(dataStr, horario) {
            if (!supabase) return true;
            
            try {
                const { data, error } = await supabase
                    .from('agendamentos_imperio')
                    .select('id')
                    .eq('data_escolhida', dataStr)
                    .eq('horario', horario)
                    .maybeSingle();
                
                if (error) throw error;
                return !data; // Dispon√≠vel se n√£o encontrar registro
            } catch (error) {
                console.error("Erro na verifica√ß√£o:", error);
                return false;
            }
        }

        async function salvarAgendamentoNoBanco(dados) {
            if (!supabase) {
                // Fallback local
                const id = 'LOCAL_' + Date.now();
                ultimoAgendamento = { id, ...dados };
                return id;
            }
            
            try {
                const { data, error } = await supabase
                    .from('agendamentos_imperio')
                    .insert([{
                        ...dados,
                        data_criacao: new Date().toISOString(),
                        status: 'confirmado'
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                ultimoAgendamento = data;
                return data.id;
            } catch (error) {
                console.error("Erro ao salvar no banco:", error);
                return null;
            }
        }

        // ======================================================
        // 6. FUN√á√ïES DE DISPLAY E INTERFACE
        // ======================================================
        async function carregarHorariosOcupados() {
            if (!supabase) return;
            
            try {
                const hoje = new Date();
                const amanha = new Date(hoje);
                amanha.setDate(hoje.getDate() + 1);
                
                const hojeStr = formatarDataParaBanco(hoje);
                const amanhaStr = formatarDataParaBanco(amanha);
                
                const { data, error } = await supabase
                    .from('agendamentos_imperio')
                    .select('data_escolhida, horario')
                    .in('data_escolhida', [hojeStr, amanhaStr]);
                
                if (error) throw error;
                
                horariosOcupados = {};
                if (data) {
                    data.forEach(agendamento => {
                        if (!horariosOcupados[agendamento.data_escolhida]) {
                            horariosOcupados[agendamento.data_escolhida] = {};
                        }
                        horariosOcupados[agendamento.data_escolhida][agendamento.horario] = true;
                    });
                }
            } catch (error) {
                console.error("Erro ao carregar hor√°rios:", error);
            }
        }

        function formatarDataParaBanco(data) {
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            const dia = data.getDate().toString().padStart(2, '0');
            const mes = (data.getMonth() + 1).toString().padStart(2, '0');
            const diaSemana = diasSemana[data.getDay()];
            return `${dia}/${mes} (${diaSemana})`;
        }

        function verificarHorarioOcupado(dataStr, horario) {
            return horariosOcupados[dataStr] && horariosOcupados[dataStr][horario];
        }

        function atualizarDisplayHorarios() {
            if (document.getElementById('gridHorarios')) {
                gerarHorariosSimples();
            }
        }

        function gerarHorariosSimples() {
            const grid = document.getElementById('gridHorarios');
            if (!grid) return;
            
            grid.innerHTML = '';
            const dataStr = getDataFormatada(diaSelecionado);
            
            // Bot√£o de Encaixe
            grid.innerHTML += `<div class="time-btn" style="grid-column:1/-1; background:rgba(255,68,68,0.2); color:#ffaaaa; border:1px solid red;" onclick="selecionarHora(this, 'Encaixe')">ENCAIXE (Sem hora fixa)</div>`;

            let minutos = 8 * 60; 
            const horaAtual = new Date().getHours();
            const minAtual = new Date().getMinutes();
            const hoje = diaSelecionado === 'hoje';

            while(minutos < 18 * 60) {
                const h = Math.floor(minutos/60);
                const m = minutos % 60;
                const horaFormatada = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                
                let classeExtra = '';
                let bloqueado = false;
                
                // Verificar se hor√°rio j√° passou (para hoje)
                if (hoje) {
                    if (h < horaAtual || (h === horaAtual && m < minAtual)) {
                        classeExtra = 'disabled'; 
                        bloqueado = true;
                    }
                }
                
                // Verificar se hor√°rio est√° ocupado
                if (verificarHorarioOcupado(dataStr, horaFormatada)) {
                    classeExtra = 'booked';
                    bloqueado = true;
                } 
                // Verificar se est√° sendo reservado
                else if (verificarHorarioBloqueado(dataStr, horaFormatada)) {
                    classeExtra = 'reserving';
                    bloqueado = true;
                }
                
                const clickAction = bloqueado ? '' : `onclick="selecionarHora(this, '${horaFormatada}')"`;
                grid.innerHTML += `<div class="time-btn ${classeExtra}" ${clickAction}>${horaFormatada}</div>`;
                minutos += 45;
            }
        }

        function selecionarHora(el, hora) {
            const dataStr = getDataFormatada(diaSelecionado);
            
            // Verificar disponibilidade
            if (hora !== 'Encaixe') {
                if (verificarHorarioOcupado(dataStr, hora)) {
                    mostrarMensagem('error', '‚ùå Este hor√°rio j√° foi agendado');
                    return;
                }
                
                if (verificarHorarioBloqueado(dataStr, hora)) {
                    mostrarMensagem('error', '‚è≥ Este hor√°rio est√° sendo reservado');
                    return;
                }
            }
            
            // Remover sele√ß√£o anterior
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
            
            // Selecionar novo
            el.classList.add('selected');
            horaSelecionada = hora;
            
            // Feedback
            esconderMensagem();
        }

        function mostrarConfirmacao() {
            if (!ultimoAgendamento) return;
            
            const detalhes = `
                <strong>üìã C√≥digo:</strong> ${ultimoAgendamento.id}<br>
                <strong>üóì Data:</strong> ${ultimoAgendamento.data_escolhida}<br>
                <strong>‚è∞ Hor√°rio:</strong> ${ultimoAgendamento.horario}<br>
                <strong>üöó Ve√≠culo:</strong> ${ultimoAgendamento.tamanho_carro.toUpperCase()}<br>
                <strong>üöø Servi√ßo:</strong> ${ultimoAgendamento.servico_nome}<br>
                <strong>üí∞ Valor:</strong> R$ ${ultimoAgendamento.valor_cobrado}<br>
                <strong>üí≥ Pagamento:</strong> ${ultimoAgendamento.forma_pagamento}<br><br>
                <small style="color:#4CAF50;"><i class="fas fa-check-circle"></i> Agendamento confirmado com sucesso!</small>
            `;
            
            document.getElementById('confirmacaoDetalhes').innerHTML = detalhes;
            document.getElementById('modalConfirmacao').style.display = 'flex';
        }

        function fecharConfirmacao() {
            document.getElementById('modalConfirmacao').style.display = 'none';
            calcular();
        }

        function enviarWhatsApp() {
            if (!ultimoAgendamento) return;
            
            const msg = `üëë *AGENDAMENTO CONFIRMADO - Imp√©rioCar* üöó\n\nüìã *C√≥digo:* ${ultimoAgendamento.id}\nüóì *Data:* ${ultimoAgendamento.data_escolhida}\n‚è∞ *Hor√°rio:* ${ultimoAgendamento.horario}\n\nüöó *Ve√≠culo:* ${ultimoAgendamento.tamanho_carro.toUpperCase()}\nüöø *Servi√ßo:* ${ultimoAgendamento.servico_nome}\nüí∞ *Valor:* R$ ${ultimoAgendamento.valor_cobrado}\nüí≥ *Pagamento:* ${ultimoAgendamento.forma_pagamento}\n\nüìç *Endere√ßo:* Rua Giovanni Segantini, 257A - Jos√© Bonif√°cio/SP\n\n*Agendamento confirmado automaticamente. Obrigado!*`;
            const telefone = "5511960671570";
            const linkZap = `https://wa.me/${telefone}?text=${encodeURIComponent(msg)}`;
            
            window.open(linkZap, '_blank');
            // N√£o fecha o modal para o usu√°rio poder copiar os dados
        }

        // ======================================================
        // 7. FUN√á√ïES AUXILIARES
        // ======================================================
        function getDataFormatada(tipo) {
            const hoje = new Date();
            const amanha = new Date(hoje); 
            amanha.setDate(hoje.getDate() + 1);
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            const dataObj = tipo === 'hoje' ? hoje : amanha;
            const dia = dataObj.getDate().toString().padStart(2, '0');
            const mes = (dataObj.getMonth() + 1).toString().padStart(2, '0');
            return `${dia}/${mes} (${diasSemana[dataObj.getDay()]})`;
        }

        function renderizarDatas() {
            const hoje = new Date();
            const amanha = new Date(hoje); 
            amanha.setDate(hoje.getDate() + 1);
            const formatar = (d) => `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}`;
            document.getElementById('labelToday').innerText = formatar(hoje);
            document.getElementById('labelTomorrow').innerText = formatar(amanha);
        }

        function renderizarServicos() {
            const container = document.getElementById('listaServicos');
            let html = '';
            servicosOpcoes.forEach((svc, index) => {
                const checked = index === 1 ? 'checked' : ''; 
                html += `
                <label class="service-item">
                    <div style="display:flex; align-items:center;">
                        <input type="radio" name="servico" value="${svc.id}" ${checked} onchange="calcular()">
                        <div><span style="font-weight:bold;">${svc.nome}</span><br><span style="font-size:0.8rem; color:#888;">${svc.desc}</span></div>
                    </div>
                    <span class="price-tag" id="tag-${svc.id}">R$ 00</span>
                </label>`;
            });
            container.innerHTML = html;
        }

        function mudarData(tipo) {
            diaSelecionado = tipo;
            document.getElementById('btnToday').className = tipo === 'hoje' ? 'date-btn selected' : 'date-btn';
            document.getElementById('btnTomorrow').className = tipo === 'amanha' ? 'date-btn selected' : 'date-btn';
            horaSelecionada = null; 
            gerarHorariosSimples();
            calcular();
        }

        function calcular() {
            const tamanho = document.getElementById('carSize').value;
            const servicoRadio = document.querySelector('input[name="servico"]:checked');
            const servicoId = servicoRadio ? servicoRadio.value : 'simples';
            
            servicosOpcoes.forEach(s => {
                const valor = precos[tamanho][s.id];
                const element = document.getElementById(`tag-${s.id}`);
                if (element) {
                    element.innerText = `R$ ${valor}`;
                }
            });
            
            const total = precos[tamanho][servicoId];
            document.getElementById('valorTotal').innerText = `R$ ${total}`;
        }

        function mostrarMensagem(tipo, texto) {
            const messageDiv = document.getElementById('messageContainer');
            if (messageDiv) {
                messageDiv.className = `message ${tipo}`;
                messageDiv.innerHTML = `<p><i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${texto}</p>`;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    if (messageDiv.style.display === 'block') {
                        esconderMensagem();
                    }
                }, 5000);
            }
        }

        function esconderMensagem() {
            const messageDiv = document.getElementById('messageContainer');
            if (messageDiv) {
                messageDiv.style.display = 'none';
            }
        }

        // ======================================================
        // 8. GALERIA E ADMIN (mantidas)
        // ======================================================
        function initGallery() {
            const container = document.getElementById('galleryContainer');
            container.innerHTML = '';
            
            if(galleryPhotos.length === 0) {
                container.innerHTML = '<div style="color:white; display:flex; justify-content:center; align-items:center; height:100%;">Sem fotos na vitrine</div><div class="gallery-caption">Adicione fotos no Admin</div>';
                return;
            }
            
            galleryPhotos.forEach((url, index) => {
                const img = document.createElement('img');
                img.src = url;
                img.className = index === 0 ? 'gallery-slide active' : 'gallery-slide';
                container.appendChild(img);
            });
            
            const caption = document.createElement('div');
            caption.className = 'gallery-caption';
            caption.innerHTML = 'Resultado Final ‚ú®';
            container.appendChild(caption);
            
            if (slideInterval) clearInterval(slideInterval);
            if (galleryPhotos.length > 1) { 
                slideInterval = setInterval(nextSlide, 3000); 
            }
        }
        
        function nextSlide() {
            const slides = document.querySelectorAll('.gallery-slide');
            if (slides.length === 0) return;
            slides[currentSlide].classList.remove('active');
            currentSlide = (currentSlide + 1) % slides.length;
            slides[currentSlide].classList.add('active');
        }
        
        let adminClicks = 0;
        function initAdminTrigger() {
            const logo = document.getElementById('crownLogo');
            if (logo) {
                logo.onclick = () => {
                    adminClicks++;
                    if(adminClicks === 5) { 
                        document.getElementById('modalLogin').style.display='flex'; 
                        adminClicks = 0; 
                    }
                    setTimeout(() => adminClicks = 0, 2000);
                };
            }
        }
        
        function logarAdmin() {
            if(document.getElementById('senhaAdmin').value === '#Ccjj9842$') {
                document.getElementById('modalLogin').style.display='none';
                document.getElementById('painelAdmin').style.display='flex';
                montarEditorPrecos();
                renderAdminPhotos();
            } else {
                alert('Senha errada');
            }
        }
        
        function montarEditorPrecos() {
            const div = document.getElementById('editorPrecos');
            div.innerHTML = '';
            for(let tam in precos) {
                div.innerHTML += `<h4 style="color:var(--gold); margin-top:10px">${tam.toUpperCase()}</h4>`;
                for(let s in precos[tam]) {
                    div.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>${s}</span>
                        <input type="number" id="p-${tam}-${s}" value="${precos[tam][s]}" style="width:60px">
                    </div>`;
                }
            }
        }
        
        function salvarPrecos() {
            for(let tam in precos) { 
                for(let s in precos[tam]) { 
                    const input = document.getElementById(`p-${tam}-${s}`);
                    if (input) {
                        precos[tam][s] = Number(input.value); 
                    }
                } 
            }
            localStorage.setItem('precosImperio', JSON.stringify(precos));
            localStorage.setItem('imperioPhotos', JSON.stringify(galleryPhotos));
            alert('Tudo salvo!');
            document.getElementById('painelAdmin').style.display='none';
            calcular(); 
            initGallery();
        }
        
        function renderAdminPhotos() {
            const container = document.getElementById('adminPhotoGrid'); 
            container.innerHTML = '';
            galleryPhotos.forEach((url, index) => {
                const div = document.createElement('div'); 
                div.className = 'admin-photo-item';
                div.innerHTML = `<img src="${url}"><button class="delete-btn" onclick="deletePhoto(${index})">X</button>`;
                container.appendChild(div);
            });
        }
        
        function deletePhoto(index) {
            if(confirm('Apagar foto?')) { 
                galleryPhotos.splice(index, 1); 
                renderAdminPhotos(); 
            }
        }
        
        async function handleFileUpload(input) {
            if (input.files && input.files.length > 0) {
                let processedCount = 0;
                for(let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    try {
                        const resizedBase64 = await compressImage(file);
                        galleryPhotos.push(resizedBase64); 
                        processedCount++;
                    } catch (err) { 
                        console.error("Erro ao processar imagem", err); 
                    }
                }
                if(processedCount > 0) { 
                    renderAdminPhotos(); 
                    alert(`${processedCount} fotos prontas! Clique em SALVAR ALTERA√á√ïES.`); 
                }
                input.value = '';
            }
        }
        
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); 
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); 
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); 
                        const maxWidth = 600;
                        const scaleSize = maxWidth / img.width; 
                        canvas.width = maxWidth; 
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d'); 
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    }; 
                    img.onerror = (err) => reject(err);
                }; 
                reader.onerror = (err) => reject(err);
            });
        }
    </script>
</body>
</html>
